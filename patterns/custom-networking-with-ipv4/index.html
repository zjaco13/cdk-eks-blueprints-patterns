
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../batch/">
      
      
        <link rel="next" href="../instana/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.1.21">
    
    
      
        <title>Customer Network with IPV4 Pattern - Amazon EKS Blueprints Patterns</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.eebd395e.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#custom-networking-on-eks" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Amazon EKS Blueprints Patterns" class="md-header__button md-logo" aria-label="Amazon EKS Blueprints Patterns" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Amazon EKS Blueprints Patterns
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Customer Network with IPV4 Pattern
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aws-samples/cdk-eks-blueprints-patterns" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/cdk-eks-blueprints-patterns
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Amazon EKS Blueprints Patterns" class="md-nav__button md-logo" aria-label="Amazon EKS Blueprints Patterns" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Amazon EKS Blueprints Patterns
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aws-samples/cdk-eks-blueprints-patterns" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/cdk-eks-blueprints-patterns
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Patterns
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Patterns
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
      
      
      
        <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
          Observability Patterns
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Observability Patterns
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/aws-observability/cdk-aws-observability-accelerator/blob/main/docs/patterns/single-new-eks-observability-accelerators/single-new-eks-native-observability.md" class="md-nav__link">
        AWS Native Observability Pattern
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/aws-observability/cdk-aws-observability-accelerator/blob/main/docs/patterns/single-new-eks-observability-accelerators/single-new-eks-opensource-observability.md" class="md-nav__link">
        Opensource Observability Pattern
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../multi-account-monitoring/" class="md-nav__link">
        Multi Account Observability Pattern
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
          Security Patterns
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Security Patterns
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../security/eks-config-rules/" class="md-nav__link">
        EKS Config Rules
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../security/encryption-at-rest/" class="md-nav__link">
        Encryption At Rest
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../security/guardduty/" class="md-nav__link">
        GuardDuty
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../security/image-scanning/" class="md-nav__link">
        Image Scanning
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../security/securityhub/" class="md-nav__link">
        SecurityHub
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../batch/" class="md-nav__link">
        AWS Batch Pattern
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Customer Network with IPV4 Pattern
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Customer Network with IPV4 Pattern
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-eks-cluster-with-amazon-eks-blueprints-for-cdk" class="md-nav__link">
    Deploy EKS Cluster with Amazon EKS Blueprints for CDK
  </a>
  
    <nav class="md-nav" aria-label="Deploy EKS Cluster with Amazon EKS Blueprints for CDK">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check-versions" class="md-nav__link">
    Check Versions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clone-the-cdk-blueprints-patterns-github-repository" class="md-nav__link">
    Clone the cdk-blueprints-patterns github repository
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-project-dependencies" class="md-nav__link">
    Install project dependencies
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#to-view-patterns-that-are-available-to-be-deployed-execute-the-following" class="md-nav__link">
    To view patterns that are available to be deployed, execute the following:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bootstrap-your-cdk-environment" class="md-nav__link">
    Bootstrap your CDK environment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#to-deploy-the-custom-networking-ipv4-pattern-run" class="md-nav__link">
    To deploy the custom-networking-ipv4 pattern, run
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#under-the-hood" class="md-nav__link">
    Under the Hood
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../instana/" class="md-nav__link">
        Instana Pattern
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../jupyterhub/" class="md-nav__link">
        Jupyterhub Pattern
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubeflow/" class="md-nav__link">
        Kubeflow Pattern
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../pipeline-multi-env-gitops/" class="md-nav__link">
        Multi environment Pipeline GitOps pattern Pattern
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../nginx/" class="md-nav__link">
        Nginx Pattern
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../secureingresscognito/" class="md-nav__link">
        Secure Ingress and Authentication Pattern
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../graviton/" class="md-nav__link">
        Graviton Pattern
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../windows/" class="md-nav__link">
        Windows Pattern
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-eks-cluster-with-amazon-eks-blueprints-for-cdk" class="md-nav__link">
    Deploy EKS Cluster with Amazon EKS Blueprints for CDK
  </a>
  
    <nav class="md-nav" aria-label="Deploy EKS Cluster with Amazon EKS Blueprints for CDK">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check-versions" class="md-nav__link">
    Check Versions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clone-the-cdk-blueprints-patterns-github-repository" class="md-nav__link">
    Clone the cdk-blueprints-patterns github repository
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-project-dependencies" class="md-nav__link">
    Install project dependencies
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#to-view-patterns-that-are-available-to-be-deployed-execute-the-following" class="md-nav__link">
    To view patterns that are available to be deployed, execute the following:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bootstrap-your-cdk-environment" class="md-nav__link">
    Bootstrap your CDK environment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#to-deploy-the-custom-networking-ipv4-pattern-run" class="md-nav__link">
    To deploy the custom-networking-ipv4 pattern, run
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#under-the-hood" class="md-nav__link">
    Under the Hood
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="custom-networking-on-eks">Custom Networking on EKS<a class="headerlink" href="#custom-networking-on-eks" title="Permanent link">¤</a></h1>
<p>On Amazon EKS clusters, the default Container Networking Interface(CNI) is implemented by the Amazon VPC CNI plugin. When VPC CNI is used in EKS clusters, by default the VPC CNI assigns pods an IP address that's selected from the primary subnet of the VPC. The primary subnet is the subnet CIDR that the primary Elastic Network Interface(ENI) is attached to; usually it's the subnet of the worker node/host in the EKS cluster. If the primary subnet CIDR is too small, the CNI may not be able to have enough IP addresses to assign to the pods running in the cluster. This is a common challenge for EKS IPv4 clusters.</p>
<p>Custom Networking provides a solution to the IP exhaustion issue by assigning the Pod IPs from secondary VPC address spaces(CIDR). When custom networking is enabled in VPC CNI, it creates secondary ENIs in the subnet defined under a custom resource named ENIConfig that includes an alternate subnet CIDR range (carved from a secondary VPC CIDR). The VPC CNI assigns pods IP addresses from the CIDR range defined in the ENIConfig Custom Resource Definition(CRD).</p>
<p>Using the Custom Networking with IPv4 pattern, you should be able to stand up an EKS cluster with VPC CNI installed and configured with custom networking enabled.</p>
<p>This pattern deploys the following resources:</p>
<ul>
<li>Creates EKS Cluster Control plane with a managed node group </li>
<li>Deploys supporting add-ons: VpcCni, CoreDns, KubeProxy, AWSLoadBalancerController</li>
<li>Enables Custom Networking configuration in VpcCni AddOn </li>
</ul>
<h2 id="prerequisites">Prerequisites:<a class="headerlink" href="#prerequisites" title="Permanent link">¤</a></h2>
<p>Ensure that you have installed the following tools on your machine.</p>
<ol>
<li><a href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html">aws cli</a></li>
<li><a href="https://Kubernetes.io/docs/tasks/tools/">kubectl</a></li>
<li><a href="https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html#getting_started_install">cdk</a></li>
<li><a href="https://docs.npmjs.com/cli/v8/commands/npm-install">npm</a></li>
<li><a href="https://github.com/mikefarah/yq/#install">yq</a></li>
<li><code>make</code></li>
</ol>
<p>Amazon EKS add-ons are only available with Amazon EKS clusters running Kubernetes version 1.18 and later.</p>
<h2 id="deploy-eks-cluster-with-amazon-eks-blueprints-for-cdk">Deploy EKS Cluster with Amazon EKS Blueprints for CDK<a class="headerlink" href="#deploy-eks-cluster-with-amazon-eks-blueprints-for-cdk" title="Permanent link">¤</a></h2>
<h3 id="check-versions">Check Versions<a class="headerlink" href="#check-versions" title="Permanent link">¤</a></h3>
<p>Make sure that, following versions are installed.
Node version is a current stable node version 18.x.</p>
<p><div class="highlight"><pre><span></span><code>node -v
v18.12.1
</code></pre></div>
NPM version must be 8.4 or above:</p>
<div class="highlight"><pre><span></span><code>npm -v
8.19.2
</code></pre></div>
<h3 id="clone-the-cdk-blueprints-patterns-github-repository">Clone the cdk-blueprints-patterns github repository<a class="headerlink" href="#clone-the-cdk-blueprints-patterns-github-repository" title="Permanent link">¤</a></h3>
<div class="highlight"><pre><span></span><code>git clone https://github.com/aws-samples/cdk-eks-blueprints-patterns.git
</code></pre></div>
<h3 id="install-project-dependencies">Install project dependencies<a class="headerlink" href="#install-project-dependencies" title="Permanent link">¤</a></h3>
<p>Once you have cloned the above repository, you can open it using your favourite IDE and run the below command to install the dependencies and build the existing patterns.</p>
<p><code>make deps</code></p>
<h3 id="to-view-patterns-that-are-available-to-be-deployed-execute-the-following">To view patterns that are available to be deployed, execute the following:<a class="headerlink" href="#to-view-patterns-that-are-available-to-be-deployed-execute-the-following" title="Permanent link">¤</a></h3>
<div class="highlight"><pre><span></span><code>npm i
make build
</code></pre></div>
<p>To list the existing CDK EKS Blueprints patterns, run</p>
<p><code>make list</code></p>
<h3 id="bootstrap-your-cdk-environment">Bootstrap your CDK environment<a class="headerlink" href="#bootstrap-your-cdk-environment" title="Permanent link">¤</a></h3>
<p><code>npx cdk bootstrap</code></p>
<p>You can now proceed with deployment of the <code>custom-networking-ipv4</code> pattern.</p>
<h3 id="to-deploy-the-custom-networking-ipv4-pattern-run">To deploy the custom-networking-ipv4 pattern, run<a class="headerlink" href="#to-deploy-the-custom-networking-ipv4-pattern-run" title="Permanent link">¤</a></h3>
<p><code>make pattern custom-networking-ipv4 deploy</code></p>
<p>Once the deployment is successful, run <code>update-kubeconfig</code> command to update the kubeconfig file with required access. You should be able to get the command from CDK output message.</p>
<div class="highlight"><pre><span></span><code>aws eks update-kubeconfig --name custom-networking-ipv4-blueprint --region $AWS_REGION --role-arn arn:aws:iam::$AWS_ACCOUNT_ID:role/custom-networking-ipv4-bl-customnetworkingipv4blue-2SR7PW3UBLIH
</code></pre></div>
<p>You can verify the resources created by executing</p>
<div class="highlight"><pre><span></span><code>kubectl get node -o wide
</code></pre></div>
<p>Output:</p>
<div class="highlight"><pre><span></span><code>NAME                                        STATUS   ROLES    AGE   VERSION                INTERNAL-IP   EXTERNAL-IP     OS-IMAGE         KERNEL-VERSION                  CONTAINER-RUNTIME
ip-10-0-18-208.us-east-2.compute.internal   Ready    &lt;none&gt;   70m   v1.24.11-eks-a59e1f0   10.0.18.208   18.116.23.237   Amazon Linux 2   5.10.173-154.642.amzn2.x86_64   containerd://1.6.19
ip-10-0-61-228.us-east-2.compute.internal   Ready    &lt;none&gt;   70m   v1.24.11-eks-a59e1f0   10.0
</code></pre></div>
<h3 id="under-the-hood">Under the Hood<a class="headerlink" href="#under-the-hood" title="Permanent link">¤</a></h3>
<p>This pattern first creates secondary CIDRs and secondary subnets with specified range of CIDRs as shown below in resourceProvider. Then the VPC CNI addon sets up custom networking based on the parameters <code>awsVpcK8sCniCustomNetworkCfg</code>, <code>eniConfigLabelDef: "topology.kubernetes.io/zone"</code> for your Amazon EKS cluster workloads with secondary subnet ranges.</p>
<ul>
<li>When the secondary CIDRs are passed to the VPC resource provider, the secondary subnets are created and registered under names <code>secondary-cidr-subnet-${order}</code> with the resource providers.</li>
<li>We enable CNI plugin with custom pod networking with below environment variables:<ul>
<li><code>AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG</code> = <code>true</code></li>
<li><code>ENI_CONFIG_LABEL_DEF</code> = <code>topology.kubernetes.io/zone</code></li>
</ul>
</li>
</ul>
<p>This deploys an ENIConfig custom resource for pod subnets (one per availability zone).</p>
<p><div class="highlight"><pre><span></span><code>import &#39;source-map-support/register&#39;;
import * as cdk from &#39;aws-cdk-lib&#39;;
import * as blueprints from &#39;@aws-quickstart/eks-blueprints&#39;;
const app = new cdk.App();
const addOn = new blueprints.addons.VpcCniAddOn({
  customNetworkingConfig: {
      subnets: [
          blueprints.getNamedResource(&quot;secondary-cidr-subnet-0&quot;),
          blueprints.getNamedResource(&quot;secondary-cidr-subnet-1&quot;),
          blueprints.getNamedResource(&quot;secondary-cidr-subnet-2&quot;),
      ]   
  },
  awsVpcK8sCniCustomNetworkCfg: true,
  eniConfigLabelDef: &#39;topology.kubernetes.io/zone&#39;
});
const blueprint = blueprints.EksBlueprint.builder()
  .addOns(addOn)
  .resourceProvider(blueprints.GlobalResources.Vpc, new blueprints.VpcProvider(undefined, {
                primaryCidr: &quot;10.2.0.0/16&quot;, 
                secondaryCidr: &quot;100.64.0.0/16&quot;,
                secondarySubnetCidrs: [&quot;100.64.0.0/24&quot;,&quot;100.64.1.0/24&quot;,&quot;100.64.2.0/24&quot;]
            }))
  .build(app, &#39;my-stack-name&#39;);
  ```

In the diagram shown below, a secondary CIDR (100/64) is assigned to each private subnet that gets created in an availability zone. Worker nodes in the EKS cluster still gets an IP address from the Primary CIDRs(10.0) range whereas the pods get an IP address from the secondary CIDR range.

![Custom-NW-IPv4](./images/custom-nw-mng.png)

This can be verified by issuing the following command
</code></pre></div>
kubectl get eniconfig
<div class="highlight"><pre><span></span><code>Output:
</code></pre></div>
NAME         AGE
us-east-2a   47m
us-east-2b   47m
us-east-2c   47m
<div class="highlight"><pre><span></span><code>An ENIConfig custom resource is created in each AZ.  Number of secondary ENIs associated with the Worker node varies by instance type.

![Custom-NW-MNG](./images/custom-nw-mng.png)

## Additional Configuration Options

VPC CNI AddOn provides some knobs to add additional advanced configuration on top of custom networking.

### Prefix Delegation

When using custom networking mode, since the node’s primary ENI is no longer used to assign Pod IP addresses, there is a decrease in the number of Pods that can run on a given EC2 instance type. To work around this limitation you can use prefix delegation with custom networking. This is an important capability because when you use custom networking, only Pods that are configured to use hostNetwork are “bound” to the host’s primary ENI. All other Pods are bound to secondary ENIs. However, with prefix delegation enabled, each secondary IP is replaced with a /28 prefix which negates the IP address loss when you use custom networking.

By default, Prefix Delegation is turned off in Vpc Cni. To check this, run the following command.
</code></pre></div>
kubectl get ds aws-node -o yaml -n kube-system | yq '.spec.template.spec.containers[].env'
<div class="highlight"><pre><span></span><code>Output:
</code></pre></div>
[...]</p>
<ul>
<li>name: ENABLE_PREFIX_DELEGATION</li>
</ul>
<p>value: "false"</p>
<p>[...]
<div class="highlight"><pre><span></span><code>Consider the maximum number of Pods for an m5.large instance with custom networking.
When using custom networking, the maximum number of Pods you can run without prefix delegation enabled is 20.

Download and run max-pods-calculator.sh script to calculate the maximum number of pods:
</code></pre></div>
curl -o max-pods-calculator.sh <a href="https://raw.githubusercontent.com/awslabs/amazon-eks-ami/master/files/max-pods-calculator.sh">https://raw.githubusercontent.com/awslabs/amazon-eks-ami/master/files/max-pods-calculator.sh</a>
chmod +x max-pods-calculator.sh
/max-pods-calculator.sh \
    --instance-type m5.large \
    --cni-version 1.12.5-eksbuild.2 \
    --cni-custom-networking-enabled
<div class="highlight"><pre><span></span><code>Output:
</code></pre></div>
20
<div class="highlight"><pre><span></span><code>To turn on `Prefix Delegation`, use the following command
</code></pre></div>
kubectl set env daemonset aws-node -n kube-system ENABLE_PREFIX_DELEGATION=true
<div class="highlight"><pre><span></span><code>Output:
`110`

![Custom-NW-Bar-Chart](./images/Custom-nw-bar-chart.png)

The reason we got max-pods is 110 instead of 290 is because the instance has a relatively low number of vCPUs. In addition the Kubernetes community recommends set max Pods no greater than 10 * number of cores, up to 110. Since Vpc Cni runs as a daemonset, you’d need to create new nodes for this to take effect.

The number of ENIs and IP addresses in a pool are configured through environment variables called `WARM_ENI_TARGET`, `WARM_IP_TARGET`, `MINIMUM_IP_TARGET`. For more details on these options, please refer to [EKS Best Practices Networking](https://aws.github.io/aws-eks-best-practices/networking/vpc-cni/#overview) Guide.


## Cleanup

To clean up your EKS Blueprints, run the following commands:


```sh
make pattern custom-networking-ipv4 destroy 
</code></pre></div></p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["tabs"], "search": "../../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.220ee61c.min.js"></script>
      
    
  </body>
</html>